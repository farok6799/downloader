<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mostafa Web Downloader</title>
    <!-- Bootstrap CSS for styling -->
    <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Bootstrap CSS Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø®ØµØµ -->
    <style>
        /* --- ØªØµÙ…ÙŠÙ… Ù…Ø³ØªÙˆØ­Ù‰ Ù…Ù† index.html --- */
        body {
            background-color: #1e1f22;
            color: #f2f3f5;
            font-family: "Segoe UI", "Roboto", sans-serif;
            margin: 0;
            padding: 2rem 0;
        }
        .container {
            background-color: #2b2d31;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 1000px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù…Ø¯ÙŠØ± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… */
            margin: auto;
        }
        h1 {
            color: #5865f2;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        input[type="text"], select {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #1e1f22;
            border-radius: 5px;
            background-color: #1e1f22;
            color: #f2f3f5;
            font-size: 16px;
        }
        button {
            background-color: #5865f2;
            color: white;
            padding: 0 24px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ù† Ø§Ù„ØªÙ‚Ù„Øµ */
        }
        button:hover {
            background-color: #4e5bf0;
        }
        /* --- ØªØµÙ…ÙŠÙ… Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª --- */
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #1e1f22;
            margin-bottom: 1.5rem;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: #b8bac0;
            font-size: 16px;
            font-weight: bold;
        }
        .tab-button.active {
            color: #5865f2;
            border-bottom: 2px solid #5865f2;
        }
        .tool-card {
            background-color: #1e1f22;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ğŸš€ Mostafa Web Downloader</h1>

        <!-- Nav Tabs -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab(event, 'downloader-panel')">â¬‡ï¸ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª</button>
            <button class="tab-button" onclick="openTab(event, 'telegram-panel')">ğŸ—‚ï¸ Ù…Ø¯ÙŠØ± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</button>
            <button class="tab-button" onclick="openTab(event, 'tools-panel')">ğŸ§° Ø§Ù„Ø£Ø¯ÙˆØ§Øª</button>
            <button class="tab-button" onclick="openTab(event, 'library-panel')">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
            <button class="tab-button" onclick="openTab(event, 'log-panel')">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</button>
            <button class="tab-button" onclick="openTab(event, 'settings-panel')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Downloader Panel -->
            <div id="downloader-panel" class="tab-content active">
                <h5>Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                <div class="input-group">
                    <input type="text" id="url-input" placeholder="ğŸ”— Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ù†Ø§...">
                    <button type="button" id="fetch-button">ğŸ” ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                </div>
                <div id="details-container" style="display: none; background-color: #1e1f22; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:</strong> <span id="filename-span"></span></p>
                    <p><strong>Ø§Ù„Ø­Ø¬Ù…:</strong> <span id="filesize-span"></span></p>
                    <div id="formats-container" style="display: none; margin-bottom: 1rem;">
                        <label for="formats-select">Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø©:</label>
                        <select id="formats-select"></select>
                    </div>
                    <button id="start-download-button" style="background-color: #248046;">âœ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
                </div>
                <div id="status-message" style="margin-top: 1rem;"></div>

                <div id="download-list" style="margin-top: 2rem;">
                    <h3>Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                    <!-- Download items will be injected here -->
                </div>
            </div>

            <!-- Telegram Manager Panel -->
            <div id="telegram-panel" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h5 style="margin: 0;">Ù…Ø¯ÙŠØ± Ù…Ù„ÙØ§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h5>
                    <button id="refresh-dialogs-btn" style="background-color: #4f545c;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ù†ÙˆØ§Øª</button>
                </div>
                <div id="telegram-status" style="margin-bottom: 1rem;"></div>
                <div style="display: flex; gap: 20px;">
                    <!-- Dialogs Column -->
                    <div style="flex: 1;">
                        <h6>Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h6>
                        <div id="telegram-dialogs-list" style="height: 500px; overflow-y: auto; background-color: #1e1f22; border-radius: 5px; padding: 5px;">
                            <!-- Dialogs will be injected here -->
                        </div>
                    </div>
                    <!-- Files Column -->
                    <div style="flex: 2;">
                        <h6>Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</h6>
                        <div id="telegram-files-list" style="height: 500px; overflow-y: auto; background-color: #1e1f22; border-radius: 5px; padding: 5px;">
                            <!-- Files will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Panel -->
            <div id="tools-panel" class="tab-content">
                <!-- Image Converter -->
                <div class="tool-card">
                    <h5>ğŸ–¼ï¸ Ù…Ø­ÙˆÙ„ ØµÙŠØº Ø§Ù„ØµÙˆØ±</h5>
                    <input type="file" id="image-converter-input" accept="image/*">
                    <select id="image-converter-format">
                        <option value="PNG">PNG</option>
                        <option value="JPG">JPG</option>
                        <option value="WEBP">WEBP</option>
                        <option value="ICO">ICO</option>
                        <option value="BMP">BMP</option>
                    </select>
                    <button id="image-converter-btn">ØªØ­ÙˆÙŠÙ„</button>
                    <div id="image-converter-status" style="margin-top: 1rem;"></div>
                </div>

                <!-- Video Merger -->
                <div class="tool-card">
                    <h5>ğŸ”— Ø¯Ù…Ø¬ ÙÙŠØ¯ÙŠÙˆ ÙˆØµÙˆØª</h5>
                    <p>ÙÙŠØ¯ÙŠÙˆ: <input type="file" id="video-merger-video-input" accept="video/*"></p>
                    <p>ØµÙˆØª: <input type="file" id="video-merger-audio-input" accept="audio/*"></p>
                    <button id="video-merger-btn">Ø¯Ù…Ø¬</button>
                    <div id="video-merger-status" style="margin-top: 1rem;"></div>
                </div>

                <!-- File Repair -->
                <div class="tool-card">
                    <h5>ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­ Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h5>
                    <input type="file" id="file-repair-input" accept="video/*,audio/*">
                    <p><input type="checkbox" id="file-repair-deep-checkbox"> <label for="file-repair-deep-checkbox">Ø¥ØµÙ„Ø§Ø­ Ø¹Ù…ÙŠÙ‚ (Ø£Ø¨Ø·Ø£)</label></p>
                    <button id="file-repair-btn">Ø¥ØµÙ„Ø§Ø­</button>
                    <div id="file-repair-status" style="margin-top: 1rem;"></div>
                </div>

                <!-- System Tools -->
                <div class="tool-card">
                    <h5>âš™ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                    <div id="ffmpeg-tool-section">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </div>
                    <div id="ytdlp-tool-section" style="margin-top: 1rem;">
                        <p>ØªØ­Ø¯ÙŠØ« Ù…ÙƒØªØ¨Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (yt-dlp) Ù„Ø­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰.</p>
                        <button id="update-ytdlp-btn">ğŸ”„ ØªØ­Ø¯ÙŠØ« yt-dlp</button>
                        <div id="update-ytdlp-status" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

            </div>

            <!-- Library Panel -->
            <div id="library-panel" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h5 style="margin: 0;">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©</h5>
                    <button id="refresh-library-btn" style="background-color: #4f545c;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>
                <div id="library-list" style="height: 500px; overflow-y: auto; background-color: #1e1f22; border-radius: 5px; padding: 10px;">
                    <!-- Library files will be injected here -->
                </div>
            </div>

            <!-- Log Panel -->
            <div id="log-panel" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h5 style="margin: 0;">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª</h5>
                    <div>
                        <button id="refresh-log-btn" style="background-color: #4f545c;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        <button id="clear-log-btn" style="background-color: #da373c;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                    </div>
                </div>
                <div id="log-list" style="height: 500px; overflow-y: auto; background-color: #1e1f22; border-radius: 5px; padding: 10px;">
                    <!-- Log entries will be injected here -->
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settings-panel" class="tab-content">
                <h5>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h5>
                <div id="settings-status" style="margin-bottom: 1rem;"></div>
                <div class="tool-card">
                    <h6>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h6>
                    <div style="margin-bottom: 1rem;">
                        <label for="settings-download-folder">Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª:</label>
                        <input type="text" id="settings-download-folder" style="width: 100%; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="settings-max-downloads">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©:</label>
                        <input type="number" id="settings-max-downloads" style="width: 100px;">
                    </div>
                    <button id="save-settings-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
                <div class="tool-card">
                    <h6>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h6>
                    <div id="telegram-login-status" style="margin-bottom: 1rem;"></div>
                    <!-- Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
                    <div id="telegram-login-section">
                        <div id="tg-login-step-phone" style="margin-bottom: 1rem;">
                            <label for="tg-phone-input">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©):</label>
                            <div class="input-group">
                                <input type="text" id="tg-phone-input" placeholder="+201234567890">
                                <button id="tg-send-code-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²</button>
                            </div>
                        </div>
                        <div id="tg-login-step-code" style="display: none; margin-bottom: 1rem;">
                            <label for="tg-code-input">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚:</label>
                            <input type="text" id="tg-code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø°ÙŠ ÙˆØµÙ„Ùƒ">
                        </div>
                        <div id="tg-login-step-password" style="display: none; margin-bottom: 1rem;">
                            <label for="tg-password-input">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†:</label>
                            <input type="password" id="tg-password-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                        </div>
                        <button id="tg-submit-btn" style="display: none;">âœ… ØªØ£ÙƒÙŠØ¯</button>
                    </div>
                    <!-- Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
                    <div id="telegram-logout-section" style="display: none;">
                        <p>Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹. <button id="tg-logout-btn" style="background-color: #da373c;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Templates (No changes needed here, but CSS will be applied) -->
    <template id="download-item-template">
        <div class="download-item" style="background-color: #383a40; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <h6 class="card-title"></h6>
            <p class="status-text" style="font-size: 0.9em; color: #b8bac0;"></p>
            <div class="progress-bar-container" style="width: 100%; background-color: #1e1f22; border-radius: 5px; margin: 8px 0;">
                <div class="progress-bar" style="width: 0%; height: 10px; background-color: #248046; border-radius: 5px; transition: width 0.2s ease-in-out;"></div>
            </div>
            <div style="margin-top: 10px;">
                <button class="pause-btn" style="background-color: #f1c40f; color: black;">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
                <button class="resume-btn" style="display: none; background-color: #3498db;">â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
                <button class="cancel-btn" style="background-color: #da373c;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </template>

    <template id="telegram-dialog-template">
         <div class="list-group-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;">
            <img src="" style="margin-right: 10px; border-radius: 50%;" width="40" height="40">
            <span class="dialog-name" style="flex-grow: 1;"></span>
            <button class="leave-dialog-btn" style="background-color: #da373c; font-size: 12px; padding: 4px 8px;">Ù…ØºØ§Ø¯Ø±Ø©</button>
        </div>
    </template>

    <template id="telegram-file-template">
        <div class="list-group-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
            <div style="display: flex; align-items: center; overflow: hidden;">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABFSURBVHja7cEBDQAAAMKg9V9tCU+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAcFIAABaVp7wQAAAABJRU5ErkJggg==" style="margin-right: 10px; max-width: 64px; max-height: 64px; object-fit: cover; border-radius: 4px;">
                <div class="file-details">
                    <p class="file-name" style="margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></p>
                    <small class="file-size" style="color: #96989d;"></small>
                </div>
            </div>
            <button class="download-tg-file-btn">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>
        </div>
    </template>

    <template id="library-item-template">
        <div class="list-group-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
            <div class="file-details">
                <p class="file-name" style="margin: 0;"></p>
                <small class="file-size" style="color: #96989d;"></small>
            </div>
        </div>
    </template>

    <template id="log-item-template">
        <div class="list-group-item" style="padding: 8px; border-radius: 4px; margin-bottom: 5px;">
            <p class="log-filename" style="margin: 0; font-weight: bold;"></p>
            <p class="log-status" style="margin: 0 0 5px 0;"></p>
            <small class="log-timestamp" style="color: #96989d;"></small>
        </div>
    </template>


    <!-- Bootstrap JS -->
    <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© Bootstrap JS Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ Ø¶Ø±ÙˆØ±ÙŠØ§Ù‹ -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø°Ø±ÙŠ: ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ Ø¹Ù„Ù‰ Railway ---
            // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ø¹Ù„Ù‰ GitHub Pages ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ RailwayØŒ
            // ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­.
            // ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©.
            const API_BASE_URL = 'https://downloader.up.railway.app';

            const appState = {
                clientId: `web-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                ws: null,
                currentDownloadDetails: null,
                telegramLogin: {
                    phone: null,
                    phone_code_hash: null,
                }
            };

            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
            window.openTab = (evt, tabName) => {
                let i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-button");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].classList.remove("active");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.classList.add("active");
            };

            // --- UI Elements ---
            const urlInput = document.getElementById('url-input');
            const fetchButton = document.getElementById('fetch-button');
            const detailsContainer = document.getElementById('details-container');
            const filenameSpan = document.getElementById('filename-span');
            const filesizeSpan = document.getElementById('filesize-span');
            const formatsContainer = document.getElementById('formats-container');
            const formatsSelect = document.getElementById('formats-select');
            const startDownloadButton = document.getElementById('start-download-button');
            const statusMessage = document.getElementById('status-message');
            const downloadList = document.getElementById('download-list');

            // --- Telegram UI Elements ---
            const refreshDialogsBtn = document.getElementById('refresh-dialogs-btn');
            const telegramStatus = document.getElementById('telegram-status');
            const dialogsList = document.getElementById('telegram-dialogs-list');
            const filesList = document.getElementById('telegram-files-list');

            // --- Tools UI Elements ---
            const imageConverterInput = document.getElementById('image-converter-input');
            const imageConverterFormat = document.getElementById('image-converter-format');
            const imageConverterBtn = document.getElementById('image-converter-btn');
            const imageConverterStatus = document.getElementById('image-converter-status');
            const videoMergerVideoInput = document.getElementById('video-merger-video-input');
            const videoMergerAudioInput = document.getElementById('video-merger-audio-input');
            const videoMergerBtn = document.getElementById('video-merger-btn');
            const videoMergerStatus = document.getElementById('video-merger-status');
            const fileRepairInput = document.getElementById('file-repair-input');
            const fileRepairDeepCheckbox = document.getElementById('file-repair-deep-checkbox');
            const fileRepairBtn = document.getElementById('file-repair-btn');
            const fileRepairStatus = document.getElementById('file-repair-status');

            // --- Library, Log, Settings UI Elements ---
            const refreshLibraryBtn = document.getElementById('refresh-library-btn');
            const libraryList = document.getElementById('library-list');
            const refreshLogBtn = document.getElementById('refresh-log-btn');
            const clearLogBtn = document.getElementById('clear-log-btn');
            const logList = document.getElementById('log-list');
            const settingsStatus = document.getElementById('settings-status');
            const settingsDownloadFolder = document.getElementById('settings-download-folder');
            const settingsMaxDownloads = document.getElementById('settings-max-downloads');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const telegramLoginStatus = document.getElementById('telegram-login-status');
            const telegramLoginSection = document.getElementById('telegram-login-section');
            const tgLoginStepPhone = document.getElementById('tg-login-step-phone');
            const tgPhoneInput = document.getElementById('tg-phone-input');
            const tgSendCodeBtn = document.getElementById('tg-send-code-btn');
            const tgLoginStepCode = document.getElementById('tg-login-step-code');
            const tgLoginStepPassword = document.getElementById('tg-login-step-password');


            // --- Templates ---
            const downloadItemTemplate = document.getElementById('download-item-template');
            const dialogTemplate = document.getElementById('telegram-dialog-template');
            const fileTemplate = document.getElementById('telegram-file-template');

            const libraryItemTemplate = document.getElementById('library-item-template');
            const logItemTemplate = document.getElementById('log-item-template');
            // --- Utility Functions ---
            const formatSize = (bytes) => {
                if (bytes === 0 || !bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            const showStatus = (message, isError = false) => {
                statusMessage.textContent = message;
                statusMessage.style.padding = '1rem';
                statusMessage.style.borderRadius = '5px';
                statusMessage.style.backgroundColor = isError ? '#da373c' : '#3498db';
                statusMessage.style.color = 'white';
                statusMessage.style.display = 'block';
            };
            
            const downloadBlob = (blob, filename) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            };

            // --- WebSocket Logic ---
            const connectWebSocket = () => {
                // --- ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø°Ø±ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†ÙˆØ§Ù† Ø®Ø§Ø¯Ù… Railway Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ WebSocket ---
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ 'https' Ø¨Ù€ 'wss' Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¢Ù…Ù†
                if (!API_BASE_URL || API_BASE_URL.includes('your-railway-app-name')) { // Check if the placeholder is still there
                    console.error("!! Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ù„ÙÙŠ (API_BASE_URL) ÙÙŠ Ù…Ù„Ù index.html.");
                    return;
                }
                const wsUrl = API_BASE_URL.replace(/^http/, 'ws');
                appState.ws = new WebSocket(`${wsUrl}/ws/${appState.clientId}`);
                
                appState.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const taskId = data.task_id;
                    const item = document.getElementById(`task-${taskId}`);
                    if (!item) return;

                    const statusText = item.querySelector('.status-text');
                    const progressBar = item.querySelector('.progress-bar');
                    const pauseBtn = item.querySelector('.pause-btn');
                    const resumeBtn = item.querySelector('.resume-btn');

                    switch (data.type) {
                        case 'progress':
                            statusText.textContent = data.text;
                            progressBar.style.width = `${Math.max(0, data.percent)}%`;
                            break;
                        case 'done':
                            statusText.textContent = data.text;
                            progressBar.style.width = '100%';
                            progressBar.style.backgroundColor = '#248046'; // Ø£Ø®Ø¶Ø±
                            pauseBtn.style.display = 'none';
                            resumeBtn.style.display = 'none';
                            item.querySelector('.cancel-btn').style.display = 'none';
                            break;
                        case 'error':
                            statusText.textContent = data.text;
                            progressBar.style.width = '100%';
                            progressBar.style.backgroundColor = '#da373c'; // Ø£Ø­Ù…Ø±
                            pauseBtn.style.display = 'none';
                            resumeBtn.style.display = 'none';
                            break;
                        case 'paused':
                            statusText.textContent = data.text;
                            progressBar.style.backgroundColor = '#f1c40f'; // Ø£ØµÙØ±
                            pauseBtn.style.display = 'none';
                            resumeBtn.style.display = 'block';
                            break;
                        case 'resumed':
                            statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù...';
                            progressBar.style.backgroundColor = '#248046'; // Ø£Ø®Ø¶Ø±
                            pauseBtn.style.display = 'block';
                            resumeBtn.style.display = 'none';
                            break;
                    }
                };

                appState.ws.onclose = () => {
                    console.log('WebSocket disconnected. Attempting to reconnect...');
                    setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
                };

                appState.ws.onerror = (err) => {
                    console.error('WebSocket error:', err);
                    appState.ws.close();
                };
            };

            // --- Downloader Logic ---
            const fetchDetails = async () => {
                const url = urlInput.value.trim();
                if (!url) return;

                showStatus('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø·...', false);
                fetchButton.disabled = true;
                detailsContainer.style.display = 'none';

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/details`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'ÙØ´Ù„ ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø·');
                    }

                    const data = await response.json();
                    appState.currentDownloadDetails = { url, ...data };

                    filenameSpan.textContent = data.filename;
                    filesizeSpan.textContent = data.total_size ? formatSize(data.total_size) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    if (data.source === 'yt-dlp' && data.details?.formats) {
                        formatsSelect.innerHTML = '<option value="">-- Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø© Ù…ØªØ§Ø­Ø© --</option>';
                        data.details.formats.forEach(f => {
                            if (f.vcodec !== 'none' && f.resolution) { // Only show video formats
                                const option = document.createElement('option');
                                option.value = f.format_id;
                                option.textContent = `${f.resolution} (${f.ext}) - ${formatSize(f.filesize || f.filesize_approx) || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                                formatsSelect.appendChild(option);
                            }
                        });
                        formatsContainer.style.display = 'block';
                    } else {
                        formatsContainer.style.display = 'none';
                    }

                    detailsContainer.style.display = 'block';
                    statusMessage.style.display = 'none';
                } catch (error) {
                    showStatus(`Ø®Ø·Ø£: ${error.message}`, true);
                } finally {
                    fetchButton.disabled = false;
                }
            };

            const startDownload = async () => {
                if (!appState.currentDownloadDetails) return;
                
                const { url, source, filename } = appState.currentDownloadDetails;
                const formatId = formatsSelect.value;
                
                // --- Ø§Ù„Ø­Ù„: Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙˆÙØªØ­Ù‡ ---
                // Ù‡Ø°Ø§ Ø³ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.
                const streamUrl = new URL(`${API_BASE_URL}/api/v1/stream`);
                streamUrl.searchParams.append('url', url);
                streamUrl.searchParams.append('filename', filename);
                streamUrl.searchParams.append('source', source);
                if (formatId) {
                    streamUrl.searchParams.append('format_id', formatId);
                }
                
                // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ù…Ù…Ø§ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
                window.location.href = streamUrl.href;
            };

            const createDownloadItem = (taskId, filename) => {
                const clone = downloadItemTemplate.content.cloneNode(true);
                const downloadItem = clone.querySelector('.download-item');
                downloadItem.id = `task-${taskId}`;
                downloadItem.querySelector('.card-title').textContent = filename;
                
                downloadItem.querySelector('.pause-btn').addEventListener('click', () => pauseDownload(taskId));
                downloadItem.querySelector('.resume-btn').addEventListener('click', () => resumeDownload(taskId));
                downloadItem.querySelector('.cancel-btn').addEventListener('click', () => cancelDownload(taskId));

                downloadList.prepend(downloadItem);
            };

            const updateDownloadItemError = (taskId, message) => {
                const item = document.getElementById(`task-${taskId}`);
                if (item) {
                    item.querySelector('.status-text').textContent = message;
                    const progressBar = item.querySelector('.progress-bar');
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#da373c'; // Ø£Ø­Ù…Ø±
                }
            };

            const pauseDownload = async (taskId) => {
                await fetch(`${API_BASE_URL}/api/v1/pause/${taskId}`, { method: 'POST' });
            };

            const resumeDownload = async (taskId) => {
                await fetch(`${API_BASE_URL}/api/v1/resume/${taskId}`, { method: 'POST' });
            };

            const cancelDownload = async (taskId) => {
                await fetch(`${API_BASE_URL}/api/v1/cancel/${taskId}`, { method: 'POST' });
                const item = document.getElementById(`task-${taskId}`);
                item?.remove();
            };

            // --- Telegram Manager Logic ---
            const fetchTelegramDialogs = async () => {
                telegramStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª...';
                dialogsList.innerHTML = '';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/telegram/dialogs`);
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª');
                    }
                    const data = await response.json();
                    data.dialogs.forEach(dialog => {
                        const clone = dialogTemplate.content.cloneNode(true);
                        const item = clone.querySelector('.list-group-item');
                        item.dataset.dialogId = dialog.id;
                        item.querySelector('.dialog-name').textContent = dialog.name;
                        if (dialog.profile_photo_bytes) {
                            item.querySelector('img').src = `data:image/jpeg;base64,${dialog.profile_photo_bytes}`;
                        }
                        
                        item.addEventListener('click', (e) => {
                            if (e.target.classList.contains('leave-dialog-btn')) return;
                            handleDialogClick(item);
                        });

                        clone.querySelector('.leave-dialog-btn').addEventListener('click', () => {
                            leaveTelegramChannel(dialog.id, dialog.name);
                        });

                        dialogsList.appendChild(clone);
                    });
                    telegramStatus.textContent = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.dialogs.length} Ù‚Ù†Ø§Ø©/Ù…Ø¬Ù…ÙˆØ¹Ø©.`;
                } catch (error) {
                    telegramStatus.textContent = `Ø®Ø·Ø£: ${error.message}`;
                }
            };

            const fetchTelegramFiles = async (dialogId) => {
                // Manage active state
                document.querySelectorAll('#telegram-dialogs-list .list-group-item').forEach(el => {
                    el.style.backgroundColor = '';
                });
                const activeItem = document.querySelector(`#telegram-dialogs-list .list-group-item[data-dialog-id='${dialogId}']`);
                if (activeItem) {
                    activeItem.style.backgroundColor = '#5865f2';
                }

                filesList.innerHTML = '<p style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/telegram/dialog/${dialogId}/files`);
                    if (!response.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');

                    filesList.innerHTML = '';
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    // Read the stream line by line (ndjson)
                    let buffer = '';
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep the last partial line

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            const fileData = JSON.parse(line);
                            if (fileData.error) {
                                filesList.innerHTML = `<p style="text-align: center; color: #e74c3c;">Ø®Ø·Ø£: ${fileData.error}</p>`;
                                return;
                            }
                            
                            const clone = fileTemplate.content.cloneNode(true);
                            clone.querySelector('.file-name').textContent = fileData.filename || 'Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                            clone.querySelector('.file-size').textContent = formatSize(fileData.size);
                            if (fileData.thumbnail) {
                                clone.querySelector('img').src = `data:image/jpeg;base64,${fileData.thumbnail}`;
                            }
                            // Store data and add event listener
                            const downloadBtn = clone.querySelector('.download-tg-file-btn');
                            downloadBtn.dataset.fileInfo = JSON.stringify(fileData);
                            downloadBtn.addEventListener('click', startTelegramDownload);

                            filesList.prepend(clone); // Prepend to show newest first
                        }
                    }
                } catch (error) {
                    filesList.innerHTML = `<p style="text-align: center; color: #e74c3c;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª: ${error.message}</p>`;
                }
            };

            const startTelegramDownload = async (event) => {
                const fileInfo = JSON.parse(event.target.dataset.fileInfo);
                if (!fileInfo) return;

                // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙÙˆØ±Ø§Ù‹
                const taskId = `${appState.clientId}-${Date.now()}`;
                createDownloadItem(taskId, fileInfo.filename);

                // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/telegram/download`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: taskId,
                            file_info: fileInfo,
                        }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'ÙØ´Ù„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…');
                    }

                    // 3. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ù„ÙŠØ±Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ‚Ø¯Ù…
                    document.querySelector('.tab-button[onclick*="downloader-panel"]').click();

                } catch (error) {
                    updateDownloadItemError(taskId, `Ø®Ø·Ø£: ${error.message}`);
                }
            };

            const handleFileRepair = async () => {
                const file = fileRepairInput.files[0];
                if (!file) {
                    fileRepairStatus.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.';
                    return;
                }
                fileRepairStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹)...';
                const formData = new FormData();
                formData.append('file', file);
                formData.append('deep_repair', fileRepairDeepCheckbox.checked);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/tools/file-repair`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'ÙØ´Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­');
                    }
                    const blob = await response.blob();
                    const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
                    const ext = file.name.substring(file.name.lastIndexOf('.'));
                    const outputFilename = `${baseName}_repaired${ext}`;
                    downloadBlob(blob, outputFilename);
                    fileRepairStatus.textContent = 'âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­!';
                } catch (error) {
                    fileRepairStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            };

            const leaveTelegramChannel = async (dialogId, dialogName) => {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© "${dialogName}"ØŸ`)) return;
                telegramStatus.textContent = `Ø¬Ø§Ø±ÙŠ Ù…ØºØ§Ø¯Ø±Ø© ${dialogName}...`;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/telegram/leave/${dialogId}`, { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail);
                    telegramStatus.textContent = result.message;
                    // Refresh dialogs list
                    fetchTelegramDialogs();
                } catch (error) {
                    telegramStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            };

            const handleDialogClick = (item) => {
                const dialogId = item.dataset.dialogId;
                fetchTelegramFiles(dialogId);
            };

            // --- Library, Log, Settings Logic ---
            const fetchLibrary = async () => {
                libraryList.innerHTML = '<p style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/library`);
                    if (!response.ok) throw new Error((await response.json()).detail);
                    const data = await response.json();
                    libraryList.innerHTML = '';
                    if (data.files.length === 0) {
                        libraryList.innerHTML = '<p style="text-align: center;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©.</p>';
                        return;
                    }
                    data.files.forEach(file => {
                        const clone = libraryItemTemplate.content.cloneNode(true);
                        clone.querySelector('.file-name').textContent = `${file.filename} (${file.folder})`;
                        clone.querySelector('.file-size').textContent = formatSize(file.size);
                        libraryList.appendChild(clone);
                    });
                } catch (error) {
                    libraryList.innerHTML = `<p style="text-align: center; color: #da373c;">âŒ Ø®Ø·Ø£: ${error.message}</p>`;
                }
            };

            const fetchLog = async () => {
                logList.innerHTML = '<p style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„...</p>';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/log`);
                    if (!response.ok) throw new Error((await response.json()).detail);
                    const data = await response.json();
                    logList.innerHTML = '';
                    if (data.log.length === 0) {
                        logList.innerHTML = '<p style="text-align: center;">Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº.</p>';
                        return;
                    }
                    data.log.forEach(entry => {
                        const clone = logItemTemplate.content.cloneNode(true);
                        clone.querySelector('.log-filename').textContent = entry.filename || 'Ù…Ù„Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        const statusP = clone.querySelector('.log-status');
                        statusP.textContent = entry.status_text;
                        statusP.style.color = entry.status === 'error' ? '#da373c' : '#248046';
                        clone.querySelector('.log-timestamp').textContent = new Date(entry.timestamp * 1000).toLocaleString();
                        logList.prepend(clone);
                    });
                } catch (error) {
                    logList.innerHTML = `<p style="text-align: center; color: #da373c;">âŒ Ø®Ø·Ø£: ${error.message}</p>`;
                }
            };

            const clearLog = async () => {
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return;
                try {
                    await fetch(`${API_BASE_URL}/api/v1/log`, { method: 'DELETE' });
                    fetchLog();
                } catch (error) {
                    logList.innerHTML = `<p style="text-align: center; color: #da373c;">âŒ Ø®Ø·Ø£: ${error.message}</p>`;
                }
            };

            const fetchAndShowSettings = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/settings`);
                    if (!response.ok) throw new Error((await response.json()).detail);
                    const settings = await response.json();
                    settingsDownloadFolder.value = settings.download_folder || '';
                    settingsMaxDownloads.value = settings.max_concurrent_downloads || 3;

                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                    const tgSettings = settings.telegram || {};
                    const isLoggedIn = tgSettings.session_string && tgSettings.session_string.length > 50;
                    document.getElementById('telegram-login-section').style.display = isLoggedIn ? 'none' : 'block';
                    document.getElementById('telegram-logout-section').style.display = isLoggedIn ? 'block' : 'none';

                    if (isLoggedIn) {
                        telegramLoginStatus.textContent = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù…: ${tgSettings.phone || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`;
                        telegramLoginStatus.style.color = 'lightgreen';
                    } else {
                        telegramLoginStatus.textContent = 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….';
                        telegramLoginStatus.style.color = 'orange';
                    }

                } catch (error) {
                    settingsStatus.textContent = `âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ${error.message}`;
                }
            };

            const handleTelegramLogin = async () => {
                const currentState = document.getElementById('tg-submit-btn').dataset.state;
                const phone = appState.telegramLogin.phone;
                const code = document.getElementById('tg-code-input').value;
                const password = document.getElementById('tg-password-input').value;
                telegramLoginStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

                try {
                    let response;
                    if (currentState === 'code') {
                        response = await fetch(`${API_BASE_URL}/api/v1/telegram/login/submit-code`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ phone: phone, phone_code_hash: appState.telegramLogin.phone_code_hash, code: code })
                        });
                    } else if (currentState === 'password') {
                        response = await fetch(`${API_BASE_URL}/api/v1/telegram/login/submit-password`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ password: password })
                        });
                    }

                    const result = await response.json();
                    if (!response.ok) {
                        if (response.status === 401 && result.detail === 'password_required') {
                            telegramLoginStatus.textContent = 'Ù…Ø·Ù„ÙˆØ¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø®Ø·ÙˆØªÙŠÙ†.';
                            document.getElementById('tg-login-step-code').style.display = 'none';
                            document.getElementById('tg-login-step-password').style.display = 'block';
                            document.getElementById('tg-submit-btn').dataset.state = 'password';
                        } else {
                            throw new Error(result.detail || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚');
                        }
                    } else {
                        telegramLoginStatus.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!';
                        telegramLoginStatus.style.color = 'lightgreen';
                        fetchAndShowSettings(); // Refresh UI
                    }
                } catch (error) {
                    telegramLoginStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                    telegramLoginStatus.style.color = '#da373c';
                }
            };

            const handleTelegramLogout = async () => {
                // This is a client-side logout for now, as there's no server-side endpoint for it.
                // We just clear the session string from settings.
                if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;
                settingsStatus.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...';
                const body = { session_string: null }; // Send null to clear it
                const response = await fetch(`${API_BASE_URL}/api/v1/settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                if (response.ok) {
                    settingsStatus.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.';
                    fetchAndShowSettings(); // Refresh UI
                } else {
                    settingsStatus.textContent = 'âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.';
                }
            };

            // --- Tools Logic ---
            const handleImageConversion = async () => {
                const file = imageConverterInput.files[0];
                if (!file) {
                    imageConverterStatus.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.';
                    return;
                }
                imageConverterStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...';
                const formData = new FormData();
                formData.append('file', file);
                formData.append('output_format', imageConverterFormat.value);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/tools/image-converter`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
                    }
                    const blob = await response.blob();
                    const outputFilename = `${file.name.split('.').slice(0, -1).join('.')}.${imageConverterFormat.value.toLowerCase()}`;
                    downloadBlob(blob, outputFilename);
                    imageConverterStatus.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!';
                } catch (error) {
                    imageConverterStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            };

            const handleVideoMerge = async () => {
                const videoFile = videoMergerVideoInput.files[0];
                const audioFile = videoMergerAudioInput.files[0];
                if (!videoFile || !audioFile) {
                    videoMergerStatus.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆÙ…Ù„Ù Ø§Ù„ØµÙˆØª.';
                    return;
                }
                videoMergerStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ù…Ø¬ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª)...';
                const formData = new FormData();
                formData.append('video_file', videoFile);
                formData.append('audio_file', audioFile);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/tools/video-merger`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'ÙØ´Ù„ Ø§Ù„Ø¯Ù…Ø¬');
                    }
                    const blob = await response.blob();
                    const outputFilename = `${videoFile.name.split('.').slice(0, -1).join('.')}_merged.mp4`;
                    downloadBlob(blob, outputFilename);
                    videoMergerStatus.textContent = 'âœ… ØªÙ… Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­!';
                } catch (error) {
                    videoMergerStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            };

            const checkAndSetupFfmpeg = async () => {
                const ffmpegSection = document.getElementById('ffmpeg-tool-section');
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/tools/check-ffmpeg`);
                    const data = await response.json();
                    if (data.installed) {
                        ffmpegSection.innerHTML = '<p style="color: lightgreen;">âœ… Ø¨Ø±Ù†Ø§Ù…Ø¬ ffmpeg Ù…Ø«Ø¨Øª ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….</p>';
                    } else {
                        ffmpegSection.innerHTML = `
                            <p style="color: orange;">âš ï¸ Ø¨Ø±Ù†Ø§Ù…Ø¬ ffmpeg ØºÙŠØ± Ù…Ø«Ø¨Øª. Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¯Ù…Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù„ÙØ§Øª.</p>
                            <button id="install-ffmpeg-btn">ğŸ“¥ ØªØ«Ø¨ÙŠØª ffmpeg ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</button>
                            <div id="install-ffmpeg-status" style="margin-top: 0.5rem;"></div>
                        `;
                        document.getElementById('install-ffmpeg-btn').addEventListener('click', async () => {
                            const statusDiv = document.getElementById('install-ffmpeg-status');
                            statusDiv.textContent = 'Ø¨Ø¯Ø£Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...';
                            await fetch(`${API_BASE_URL}/api/v1/tools/install-ffmpeg`, { method: 'POST' });
                            statusDiv.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ«Ø¨ÙŠØª. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.';
                        });
                    }
                } catch (error) {
                    ffmpegSection.innerHTML = '<p style="color: red;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ffmpeg.</p>';
                }
            };

            const handleYtdlpUpdate = async () => {
                const statusDiv = document.getElementById('update-ytdlp-status');
                statusDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
                try {
                    await fetch(`${API_BASE_URL}/api/v1/tools/update-ytdlp`, { method: 'POST' });
                    statusDiv.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.';
                } catch (error) {
                    statusDiv.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            };

            // --- Event Listeners ---
            fetchButton.addEventListener('click', fetchDetails);
            urlInput.addEventListener('keypress', (e) => e.key === 'Enter' && fetchDetails());
            startDownloadButton.addEventListener('click', startDownload);

            // Telegram Listeners
            refreshDialogsBtn.addEventListener('click', fetchTelegramDialogs);

            // Tools Listeners
            imageConverterBtn.addEventListener('click', handleImageConversion);
            videoMergerBtn.addEventListener('click', handleVideoMerge);
            fileRepairBtn.addEventListener('click', handleFileRepair);
            document.getElementById('update-ytdlp-btn').addEventListener('click', handleYtdlpUpdate);

            // Library, Log, Settings Listeners
            refreshLibraryBtn.addEventListener('click', fetchLibrary);
            refreshLogBtn.addEventListener('click', fetchLog);
            clearLogBtn.addEventListener('click', clearLog);
            saveSettingsBtn.addEventListener('click', async () => {
                settingsStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...';
                const body = {
                    download_folder: settingsDownloadFolder.value,
                    max_concurrent_downloads: parseInt(settingsMaxDownloads.value, 10)
                };
                const response = await fetch(`${API_BASE_URL}/api/v1/settings`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const result = await response.json();
                settingsStatus.textContent = response.ok ? 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.' : `âŒ Ø®Ø·Ø£: ${result.detail}`;
            });
            tgSendCodeBtn.addEventListener('click', async () => {
                const phone = tgPhoneInput.value.trim();
                if (!phone) {
                    telegramLoginStatus.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.';
                    return;
                }
                telegramLoginStatus.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...';
                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/telegram/login/send-code`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: phone })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail);
                    appState.telegramLogin.phone = phone;
                    appState.telegramLogin.phone_code_hash = result.phone_code_hash;
                    telegramLoginStatus.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø². ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø£Ø¯Ù†Ø§Ù‡.';
                    tgLoginStepPhone.style.display = 'none';
                    tgLoginStepCode.style.display = 'block';
                    document.getElementById('tg-submit-btn').style.display = 'block';
                    document.getElementById('tg-submit-btn').dataset.state = 'code';
                } catch (error) {
                    telegramLoginStatus.textContent = `âŒ Ø®Ø·Ø£: ${error.message}`;
                }
            });
            document.getElementById('tg-submit-btn').addEventListener('click', handleTelegramLogin);
            document.getElementById('tg-logout-btn').addEventListener('click', handleTelegramLogout);

            // --- Initializations ---
            connectWebSocket();
            // Automatically fetch data when switching to a tab for the first time
            document.querySelector('.tab-button[onclick*="telegram-panel"]').addEventListener('click', () => {
                if (dialogsList.children.length === 0) {
                    fetchTelegramDialogs();
                }
            }, { once: true });
            document.querySelector('.tab-button[onclick*="tools-panel"]').addEventListener('click', () => {
                // ØªØ­Ù‚Ù‚ Ù…Ù† ffmpeg ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ÙŠØªÙ… ÙÙŠÙ‡Ø§ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
                checkAndSetupFfmpeg();
            }, { once: true });
            document.querySelector('.tab-button[onclick*="library-panel"]').addEventListener('click', () => {
                if (libraryList.children.length === 0) {
                    fetchLibrary();
                }
            }, { once: true });
            document.querySelector('.tab-button[onclick*="log-panel"]').addEventListener('click', () => {
                if (logList.children.length === 0) {
                    fetchLog();
                }
            }, { once: true });
            document.querySelector('.tab-button[onclick*="settings-panel"]').addEventListener('click', () => {
                fetchAndShowSettings();
            }, { once: true });
        });
    </script>
</body>
</html>